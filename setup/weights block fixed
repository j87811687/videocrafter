# -------------------- Download & Verify VideoCrafter Weights --------------------
mkdir -p checkpoints
cd checkpoints

REPO_URL="https://huggingface.co/VideoCrafter/VideoCrafter"
REPO_DIR="VideoCrafter"

# Minimal VC1 inference subset (I2V + T2V) - git files
REQUIRED_GIT_FILES=(
	"configs/inference/i2v_videocrafter.yaml"
	"configs/inference/t2v_videocrafter.yaml"
)

#  Minimal VC1 inference subset (I2V + T2V) - lfs tracked files, relevant for size comparison
REQUIRED_LFS_TRACKED_FILES=(
	"models/i2v/model.ckpt"
	"models/t2v/model.ckpt"
)

# Expected sizes and OIDs derived from pointer files (after clone, before first git lfs pull)
declare -A EXPECTED_SIZE
declare -A EXPECTED_OID

load_pointer_metadata() {
	# Extract expected size + oid from working-tree pointer files ($REPO_DIR/$f),
	# called only after a fresh clone and BEFORE the first git lfs pull.
	for f in "${REQUIRED_LFS_TRACKED_FILES[@]}"; do

		if [ -n "${STORED_SIZE[$f]:-}" ]; then
			EXPECTED_SIZE["$f"]="${STORED_SIZE[$f]}"
			valid_size_files=$((valid_size_files+1))
			if [ -n "${STORED_OID[$f]:-}" ]; then
				EXPECTED_OID["$f"]="${STORED_OID[$f]}"
			fi
			continue
		fi

		local pointer_path="$REPO_DIR/$f"

		if [ ! -f "$pointer_path" ]; then
			echo "âŒ Failed to proper clone repo - missing pointer file."
			rm -rf "$REPO_DIR" 2>/dev/null || true
			if [ $clone_run -eq $MAX_CLONE_RUNS ]; then
				echo "âŒ Setup aborted â€” VideoCrafter is NOT operational."
				exit 1
			fi
			clone_run=$((clone_run+1))
			continue 2
		fi

		local size_line oid_line size_val oid_val
		size_line=$(grep -E '^size ' "$pointer_path" 2>/dev/null || true)
		oid_line=$(grep -E '^oid ' "$pointer_path" 2>/dev/null || true)

		size_val=$(echo "$size_line" | awk '{print $2}')
		oid_val=$(echo "$oid_line" | sed -E 's/^oid sha256://')

		if [ -n "$size_val" ]; then
			EXPECTED_SIZE["$f"]="$size_val"
			
			key="$f"
			val="${EXPECTED_SIZE[$key]}"
			# If the key exists â†’ replace the whole line
			if grep -q "^STORED_SIZE\[$key\]=" "$STATE_FILE"; then
				sed -i "s/^STORED_SIZE\[$key\]=.*/STORED_SIZE[$key]=$val/" "$STATE_FILE"
			else
				# If missing â†’ append
				echo "STORED_SIZE[$f]=${EXPECTED_SIZE[$f]}" >> "$STATE_FILE"
			fi
			valid_size_files=$((valid_size_files+1))
		else
			echo "âŒ Failed to proper clone repo - no size in pointer file."
			rm -rf "$REPO_DIR" 2>/dev/null || true
			if [ $clone_run -eq $MAX_CLONE_RUNS ]; then
				echo "âŒ Setup aborted â€” VideoCrafter is NOT operational."
				exit 1
			fi
			clone_run=$((clone_run+1))
			continue 2
		fi
		if [ -n "$oid_val" ]; then
			EXPECTED_OID["$f"]="$oid_val"

			key="$f"
			val="${EXPECTED_OID[$key]}"
			# If the key exists â†’ replace the whole line
			if grep -q "^STORED_OID\[$key\]=" "$STATE_FILE"; then
				sed -i "s/^STORED_OID\[$key\]=.*/STORED_OID[$key]=$val/" "$STATE_FILE"
			else
				# If missing â†’ append
				echo "STORED_OID[$f]=${EXPECTED_OID[$f]}" >> "$STATE_FILE"
			fi
		fi
	done
}

# Check all REQUIRED_LFS_TRACKED_FILES:
#  - if missing â†’ add to missing_list
#  - if exists and (actual size is empty OR size mismatch) â†’ delete file + LFS cache (if possible) and add to missing_list
find_missing_weights() {
	missing_list=()

	for f in "${REQUIRED_LFS_TRACKED_FILES[@]}"; do
		local full_path="$REPO_DIR/$f"

		if [ ! -f "$full_path" ]; then
			# Completely missing file
			missing_list+=("$f")
			continue
		fi

		# Extract actual size and compare sizes
		local expected_size="${EXPECTED_SIZE[$f]}"
		
		# Actual file size (Linux stat)
		local actual_size
		actual_size=$(stat -c%s "$full_path" 2>/dev/null || echo "")

		if [ -z "$actual_size" ] || [ "$actual_size" != "$expected_size" ]; then
			echo "âš ï¸ Size mismatch for $f (expected: ${expected_size} bytes, got: ${actual_size:-unknown})."
			echo "   Treating as corrupted LFS object â€” removing file and cache entry."

			# Delete working-tree file
			rm -f "$full_path" 2>/dev/null || true

			# Mark as missing so it will be re-downloaded
			missing_list+=("$f")
			continue
		fi
	done
}

# Helper: delete LFS cache objects for files on missing list (if we have its OID)
delete_lfs_cache_objects() {
	for f in "${missing_list[@]}"; do

		local oid="${EXPECTED_OID[$f]}"

		[ -n "$oid" ] || continue

		# OID is pure hex; first 2 + next 2 form subdirs
		local short1 short2 obj_path
		short1="${oid:0:2}"
		short2="${oid:2:2}"
		obj_path="$REPO_DIR/.git/lfs/objects/$short1/$short2/$oid"

		rm -f "$obj_path" 2>/dev/null || true
	done
}

git lfs install

MAX_WEIGHT_RUNS=2
weights_ok=0
run=1

while [ $run -le $MAX_WEIGHT_RUNS ]; do
	echo "=== VideoCrafter weights sync run $run/$MAX_WEIGHT_RUNS ==="

	MAX_CLONE_RUNS=3
	clone_run=1

	while [ $clone_run -le $MAX_CLONE_RUNS ]; do
		echo "=== VideoCrafter repo clone run $clone_run/$MAX_CLONE_RUNS ==="

		# If repo missing or invalid, start from a clean slate
		if [ ! -d "$REPO_DIR/.git" ]; then
			rm -rf "$REPO_DIR" 2>/dev/null || true
			echo "â¬‡ï¸ Cloning VideoCrafter repository (weights repo)..."

			for attempt in 1 2 3; do
				echo "ğŸ” git clone attempt $attempt/3..."
				GIT_LFS_SKIP_SMUDGE=1 git clone "$REPO_URL" "$REPO_DIR" && break
				sleep 3
			done

			if [ ! -d "$REPO_DIR/.git" ]; then
				echo "âŒ Failed to clone VideoCrafter weights repo after 3 attempts."
				if [ $clone_run -eq $MAX_CLONE_RUNS ]; then
					echo "âŒ Setup aborted â€” VideoCrafter is NOT operational."
					exit 1
				fi
				clone_run=$((clone_run+1))
				continue
			fi
		fi

		# Check for existence of git files
		for f in "${REQUIRED_GIT_FILES[@]}"; do
			if [ ! -f "$REPO_DIR/$f" ]; then
				rm -rf "$REPO_DIR" 2>/dev/null || true
				echo "âš ï¸ Missing GIT file detected: $f"
				if [ $clone_run -eq $MAX_CLONE_RUNS ]; then
					echo "âŒ Setup aborted â€” VideoCrafter is NOT operational."
					exit 1
				fi
				clone_run=$((clone_run+1))
				continue 2
			fi
		done

# CLONE SUCCESSFUL, 2 GIT FILES EXIST

		# After successful clone and BEFORE the first git lfs pull, extract pointer sizes
		EXPECTED_SIZE=()
		EXPECTED_OID=()
		valid_size_files=0
		load_pointer_metadata

		if [ "$valid_size_files" -eq 2 ]; then
			break
		fi
	done

# size extraction successful, 2 expected_size values exist

	# 1) Full LFS pull for this repo
	cd "$REPO_DIR"
	for attempt in 1 2 3; do
		echo "ğŸ” git lfs pull attempt $attempt/3..."
		git lfs pull && break
		sleep 3
	done
	cd ..

	# 2) First check
	find_missing_weights
	delete_lfs_cache_objects
	if [ ${#missing_list[@]} -eq 0 ]; then
		echo "âœ… All VideoCrafter weight files successfully verified."
		weights_ok=1
		break  # Exit the outer run loop
	fi

	echo "âš ï¸ Missing or corrupted LFS files detected:"
	printf ' - %s\n' "${missing_list[@]}"

	# 3) Force re-download of missing/corrupted files
	cd "$REPO_DIR"
	for f in "${missing_list[@]}"; do
		for attempt in 1 2 3; do
			echo "ğŸ” Forcing re-download of LFS file: $f, attempt $attempt/3..."
			if [ -n "${EXPECTED_OID[$f]}" ]; then
				git lfs pull --include="$f" && break
			else
				git lfs fetch --include="$f" --force
				git lfs checkout "$f" && break
			fi
			sleep 3
		done
	done
	cd ..

	# 4) Second check in this run
	find_missing_weights
	if [ ${#missing_list[@]} -eq 0 ]; then
		echo "âœ… All VideoCrafter weight files successfully verified after targeted re-download."
		weights_ok=1
		break  # Exit the outer run loop
	fi

	echo "âš ï¸ Missing files persist after targeted re-download in run $run/$MAX_WEIGHT_RUNS."
	echo "   Removing weights repo and preparing for a fresh attempt..."

	# Delete entire repo so next run re-clones fresh
	rm -rf "$REPO_DIR" 2>/dev/null || true

	run=$((run+1))
done

if [ $weights_ok -ne 1 ]; then
	echo "âŒ Missing required VideoCrafter weight files even after full retry:"
	printf ' - %s\n' "${missing_list[@]}"
	rm -rf "$REPO_DIR" 2>/dev/null || true
	echo "âŒ Setup aborted â€” VideoCrafter is NOT operational."
	exit 1
fi

echo "âœ… All VideoCrafter weight files successfully verified."
cd ..
